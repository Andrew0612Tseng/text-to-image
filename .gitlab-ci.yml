stages:
  - test
  - build
  - deploy

variables:
  PROJECT_ID: first-torus-456214-a4
  BACKEND_IMAGE: gcr.io/${PROJECT_ID}/text-to-image-backend
  FRONTEND_IMAGE: gcr.io/${PROJECT_ID}/text-to-image-frontend
  REGION: asia-east1
  BACKEND_SERVICE_NAME: text-to-image-backend
  FRONTEND_SERVICE_NAME: text-to-image-frontend

# 測試後端
test-backend:
  stage: test
  image: python:3.11-slim
  script:
    - echo "OPENAI_API_KEY=$OPENAI_API_KEY" > .env
    - cd app
    - pip install -r requirements.txt
  only:
    - develop

# 建立前端映像
build-frontend:
  stage: build
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - echo "$GCP_SERVICE_KEY" | base64 -d > gcloud-service-key.json
    - docker login -u _json_key --password-stdin https://gcr.io < gcloud-service-key.json
  script:
    - cd frontend
    - docker build -t $FRONTEND_IMAGE .
    - docker push $FRONTEND_IMAGE
  only:
    - develop

# 建立後端映像
build-backend:
  stage: build
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - echo "$GCP_SERVICE_KEY" | base64 -d > gcloud-service-key.json
    - docker login -u _json_key --password-stdin https://gcr.io < gcloud-service-key.json
  script:
    - cd app
    - docker build -t $BACKEND_IMAGE .
    - docker push $BACKEND_IMAGE
  only:
    - develop
  needs:
    - test-backend

